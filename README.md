# Сервис назначения ревьюеров для Pull Request'ов - Стажировка Avito

## Описание проекта

Микросервис для автоматического назначения ревьюеров на Pull Request'ы внутри команд. Сервис позволяет управлять командами, участниками, создавать PR с автоматическим назначением ревьюверов, выполнять переназначение и получать статистику по назначениям.

### Быстрый старт

```bash
# Клонировать репозиторий
git clone https://github.com/sirdont0/Service-for-PR
cd Service-for-PR

# Запустить сервис (БД, миграции и приложение)
docker-compose up --build

# Сервис будет доступен на http://localhost:8080
```

## Архитектура решения

Проект реализован на Go и разделен на следующие слои:

### Структура проекта

```
avito/
├── cmd/server/          # Точка входа приложения
├── internal/
│   ├── domain/          # Доменные модели (User, Team, PullRequest)
│   ├── repository/      # Интерфейсы репозитория
│   │   └── pg/          # PostgreSQL реализация репозитория
│   ├── usecase/         # Бизнес-логика
│   ├── transport/http/  # HTTP handlers и роутинг
│   └── infra/           # Инфраструктурные компоненты (logger)
├── migrations/          # SQL миграции
├── docker-compose.yml   # Конфигурация для запуска сервиса
└── Makefile             # Команды для сборки и тестирования
```

### Технологический стек

- **Язык**: Go 1.21
- **База данных**: PostgreSQL 15
- **HTTP роутинг**: Gorilla Mux
- **Миграции**: migrate/migrate
- **Линтер**: golangci-lint

## Реализованный функционал

### Основные требования

**Управление командами и пользователями**
- Создание команды с участниками (`POST /team/add`)
- Получение информации о команде (`GET /team/get`)
- Установка флага активности пользователя (`POST /users/setIsActive`)

**Управление Pull Request'ами**
- Создание PR с автоматическим назначением до 2 ревьюверов из команды автора (`POST /pullRequest/create`)
- Переназначение ревьювера (`POST /pullRequest/reassign`)
- Merge PR (идемпотентная операция) (`POST /pullRequest/merge`)
- Получение списка PR пользователя (`GET /users/getReview`)

**Бизнес-логика**
- Автоматическое назначение до 2 активных ревьюверов из команды автора (исключая самого автора)
- Переназначение заменяет одного ревьювера на случайного активного участника из команды заменяемого
- Запрет изменения ревьюверов после MERGED
- Если доступных кандидатов меньше двух, назначается доступное количество (0/1)
- Пользователи с `isActive = false` не назначаются на ревью

**Технические требования**
- Сервис поднимается командой `docker-compose up`
- Миграции применяются автоматически при запуске
- Сервис доступен на порту 8080
- Health check endpoint (`GET /health`)

### Дополнительные функции

**Эндпоинт статистики** (`GET /statistics/reviewers`)
- Возвращает статистику назначений по пользователям
- Показывает количество назначений для каждого пользователя
- Сортировка по количеству назначений (по убыванию)

## Детали реализации

### Алгоритм назначения ревьюверов

При создании PR:
1. Проверяется существование PR (не должно быть дубликатов)
2. Получается информация об авторе и его команде
3. Выбираются активные участники команды (исключая автора)
4. Список кандидатов перемешивается случайным образом
5. Выбирается до 2 ревьюверов
6. При назначении ревьюверы автоматически деактивируются (чтобы не перегружать их)

### Алгоритм переназначения

При переназначении ревьювера:
1. Проверяется статус PR (должен быть OPEN)
2. Проверяется, что старый ревьювер действительно назначен
3. Получается команда старого ревьювера
4. Исключаются из кандидатов: автор PR, текущие ревьюверы, старый ревьювер
5. Выбирается случайный активный кандидат из команды
6. Старый ревьювер удаляется, новый добавляется
7. Если у старого ревьювера нет других открытых PR, он активируется
8. Новый ревьювер деактивируется

### Управление активностью пользователей

- При назначении на PR пользователь автоматически деактивируется
- При переназначении старый ревьювер активируется, если у него нет других открытых PR
- При merge PR все ревьюверы автоматически активируются
- Это позволяет равномерно распределять нагрузку между участниками команды

### Транзакции и блокировки

- Все операции с БД выполняются в транзакциях
- При переназначении и merge используется `FOR UPDATE` для предотвращения race conditions
- Используется оптимистичная блокировка через проверку статуса PR

## API Endpoints

### Основные эндпоинты (из спецификации)

- `GET /health` - Health check
- `POST /team/add` - Создать команду с участниками
- `GET /team/get?team_name={name}` - Получить команду
- `POST /users/setIsActive` - Установить флаг активности
- `GET /users/getReview?user_id={id}` - Получить PR пользователя
- `POST /pullRequest/create` - Создать PR
- `POST /pullRequest/reassign` - Переназначить ревьювера
- `POST /pullRequest/merge` - Merge PR

### Дополнительные эндпоинты

- `GET /statistics/reviewers` - Статистика назначений по пользователям

**Пример ответа:**
```json
{
  "statistics": [
    {
      "user_id": "u1",
      "username": "alice",
      "assignments_count": 5
    },
    {
      "user_id": "u2",
      "username": "bob",
      "assignments_count": 3
    }
  ]
}
```

## Изменения в OpenAPI спецификации

В спецификацию добавлено:

1. **Новый код ошибки**: `VALIDATION_ERROR` - для ошибок валидации входных данных
2. **Новый эндпоинт**: `/statistics/reviewers` (GET) - для получения статистики назначений

Эти изменения не нарушают обратную совместимость с существующим API.

## Тестирование

### Покрытие тестами

Проект включает comprehensive unit-тесты для всех основных компонентов:

- **internal/usecase**:
  - Тесты для создания PR (все edge cases)
  - Тесты для переназначения ревьюверов
  - Тесты для merge PR
  - Тесты для вспомогательных функций

- **internal/transport/http**:
  - Тесты для всех HTTP handlers
  - Тесты для валидации входных данных
  - Тесты для обработки ошибок
  - Тесты для всех эндпоинтов

- **internal/infra**:
  - Тесты для logger

### Запуск тестов

```bash
# Запуск всех тестов
make test

# Или напрямую
go test ./... -v

# С покрытием
go test ./... -cover
```

### Типы тестов

1. **Unit-тесты** - для бизнес-логики (usecase)
2. **Integration-тесты** - для HTTP handlers с mock репозиторием
3. **Вспомогательные тесты** - для утилитных функций

Всего написано **39 тестов**, покрывающих основные сценарии и edge cases.

## Вопросы и решения

### 1. Управление активностью пользователей

**Вопрос**: Как управлять активностью пользователей при назначении/переназначении?

**Решение**: 
- При назначении на PR пользователь автоматически деактивируется
- При переназначении старый ревьювер активируется, если у него нет других открытых PR
- При merge все ревьюверы активируются
- Это обеспечивает равномерное распределение нагрузки

### 2. Проверка статуса PR при переназначении

**Вопрос**: В каком порядке проверять условия при переназначении?

**Решение**: 
Сначала проверяется статус PR (должен быть OPEN), затем проверяется, что ревьювер назначен. Это позволяет быстрее отклонить запросы для уже смерженных PR.

### 3. Идемпотентность merge

**Вопрос**: Как обеспечить идемпотентность операции merge?

**Решение**: 
При повторном вызове merge для уже смерженного PR операция просто возвращает текущее состояние PR без ошибки. Это реализовано через проверку статуса перед обновлением.

### 4. Обработка ошибок валидации

**Вопрос**: Какой HTTP статус возвращать при ошибках валидации?

**Решение**: 
Добавлен новый код ошибки `VALIDATION_ERROR` и HTTP статус 400 (Bad Request) для ошибок валидации входных данных, чтобы отличать их от других ошибок.

### 5. Статистика назначений

**Вопрос**: Какую статистику показывать?

**Решение**: 
Реализована статистика по количеству назначений для каждого пользователя. Это позволяет видеть, кто из участников команды чаще всего назначается ревьювером, что полезно для анализа распределения нагрузки.

### 6. Транзакции и конкурентность

**Вопрос**: Как обеспечить корректность при одновременных запросах?

**Решение**: 
Используются транзакции PostgreSQL с блокировкой строк (`FOR UPDATE`) при операциях переназначения и merge. Это предотвращает race conditions и обеспечивает консистентность данных.

## Запуск проекта

### Требования

- Docker и Docker Compose
- Go 1.21+ (для локальной разработки)


### Локальная разработка

```bash

# ОДНОЙ командной
make

# или по частям ->

# Установить зависимости
go mod download

# Запустить линтер
make lint

# Запустить тесты
make test

# Запустить только БД
docker-compose up -d db

# Применить миграции
docker run --rm -v $(pwd)/migrations:/migrations --network host migrate/migrate \
  -path=/migrations -database "postgres://postgres:postgres@localhost:5433/prsdb?sslmode=disable" up

# Запустить приложение
DATABASE_URL="postgres://postgres:postgres@localhost:5433/prsdb?sslmode=disable" PORT=8080 go run cmd/server/main.go

```

### Переменные окружения

- `DATABASE_URL` - строка подключения к PostgreSQL (по умолчанию из docker-compose стоит порт 5433, так как данный порт вряд ли занят существующей бд, как это было у меня. Однако, для эталонного решения можно в docker-compose.yml изменить проброс портов на 5432:5432 в разделе db)
- `PORT` - порт для HTTP сервера (по умолчанию 8080)

## Makefile команды

```bash
make start     # Запустить все (lint, test, docker-up)
make all       # Запустить последовательно lint, test с проверкой предыдущего этапа на ошибки
make lint      # Запустить линтер
make test      # Запустить линтер и тесты
make docker-up # Запустить docker-compose
```

## Производительность

Сервис оптимизирован для указанных требований:
- **RPS**: 5 запросов в секунду
- **SLI времени ответа**: 300 мс
- **SLI успешности**: 99.9%

Оптимизации:
- Использование connection pooling для БД
- Эффективные SQL запросы с индексами
- Минимальное количество запросов к БД
- Транзакции для обеспечения консистентности

## Линтер

Проект использует `golangci-lint` с конфигурацией в `.golangci.yml`.

Проверяются:
- Статический анализ кода
- Проверка ошибок (errcheck)
- Проверка дублирования кода (dupl)
- Безопасность (gosec)
- Стиль кода (gocritic)

Все проверки проходят успешно: **0 issues**.

## Структура базы данных

### Таблицы

- `teams` - команды
- `users` - пользователи
- `pr_statuses` - статусы PR (OPEN, MERGED)
- `pull_requests` - Pull Request'ы
- `pr_reviewers` - связь PR и ревьюверов

### Индексы

- `idx_users_team_active` - для быстрого поиска активных пользователей команды
- `idx_pr_author` - для поиска PR по автору
- `idx_pr_status` - для фильтрации по статусу
- `idx_pr_reviewers_reviewer` - для поиска PR по ревьюверу
- `idx_pr_reviewers_pr` - для поиска ревьюверов PR
