# PR Assign Service (Avito-style)

Сервис соответствует тестовому заданию «Сервис назначения ревьюеров для PR». HTTP-контракт полностью задокументирован в `openapi.yaml` (оригинальная спецификация из задания).

## Быстрый старт

1. Установите Docker и docker-compose.
2. Поднимите окружение:
   ```bash
   docker-compose up --build
   ```
3. После применения миграций сервис будет доступен на `http://localhost:8080`.
4. Проверка здоровья:
   ```bash
   curl http://localhost:8080/health
   # {"status":"OK"}
   ```

## Основные возможности

- `POST /team/add` — создание новой команды (строго соответствует правилу «TEAM_EXISTS» при повторе).
- `GET /team/get` — чтение команды и списка участников.
- `POST /users/setIsActive` — смена активности с возвратом `team_name`.
- `POST /pullRequest/create` — создание PR и автоматическое назначение до двух ревьюверов из команды автора.
- `POST /pullRequest/reassign` — переназначение ревьювера с гарантией, что после `MERGED` изменения запрещены.
- `POST /pullRequest/merge` — идемпотентный merge.
- `GET /users/getReview` — список PR, где пользователь участвует как ревьювер.
- `GET /health` — проверка статуса.

Все ответы и коды ошибок соответствуют `openapi.yaml`. Для транспортных ошибок (например, некорректный JSON) используется код `NOT_FOUND`, т.к. спецификация разрешает только фиксированный enum.

## Схема данных и гарантии

- PostgreSQL, миграции в `migrations/`.
- Ограничение «не больше двух ревьюверов на PR» enforced триггером `check_pr_reviewer_limit`.
- Все критические операции (`create`, `reassign`, `merge`) выполняются внутри транзакций с блокировками `FOR UPDATE`, что исключает гонки.

## Тесты

- Юнит-тесты бизнес-логики: `make test`.
- (Дополнительно) интеграционные тесты можно покрыть через `docker-compose up` + Postman, опираясь на `openapi.yaml`.

## Допущения и пояснения

- Требование OpenAPI запрещает произвольные коды ошибок. Поэтому для любых транспортных 400/500 используется ближайший допустимый код (`NOT_FOUND`) с поясняющим сообщением.
- `/users/getReview` возвращает `404`, если пользователь не существует, иначе — пустой список.
- `openapi.yaml` копирует исходное задание и хранится в корне репозитория для удобства проверки.

Вся доменная логика находится в `internal/usecase`, слои данных — в `internal/repository`, HTTP — в `internal/transport/http`. Логи — стандартный вывод (`infra.Logger`). Если потребуются дополнительные вопросы/допущения — они отражаются в этом разделе README.
